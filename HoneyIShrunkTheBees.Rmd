---
title: "Honey I Shrunk the Bees!"
author: "Chris G Martin"
date: "May 15, 2016"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    highlight: pygments
    theme: cerulean
  pdf_document: default
---





```{r include=FALSE, cache=FALSE}
# DO NOT REMOVE
# THIS IS FOR SETTING SOME PLOTTING PARAMETERS SO THAT YOUR PLOTS DON'T TAKE UP TOO MUCH SPACE
# IF YOU WOULD LIKE TO CHANGE THESE, SEE HELP FILES ON THE par() FUNCTION
# OR ASK FOR HELP
library(knitr)
## set global chunk options
opts_chunk$set(fig.path='figure/manual-', cache.path='cache/manual-', fig.align='center', fig.show='hold', par=TRUE)
## tune details of base graphics (http://yihui.name/knitr/hooks)
knit_hooks$set(par=function(before, options, envir){
if (before && options$fig.show!='none') par(mar=c(4,4,.2,.1),cex.lab=.95,cex.axis=.9,mgp=c(2,.7,0),tcl=-.3)
})
```


## Part 1 - Introduction:

Bees: the most effective pollinator on the planet. In the United States, we seem to have a love/hate relationship with these facinating creatures: on the one hand we are well aware and appreciative of their role in nature and yet the number of bees is quickly dwindling without us giving any significant help. But, one of the many questions we will explore here is: do we rely on them?

By looking at a variety of data, we hope to find links between the production of honey and other agricultural statistics.

### Why Honey:

Collecting honey is an ancient tradition dating back over 8,000 years ago$^1$. It's a product made by bees while foraging for nectar from flowers. While honey bees are the most common type of bee that produces honey that humans extract for food, there are a number of other bees and wasps that do create honey, and all bees and other insects pollinate. For the purposes of this project, we are going to ignore the details and make the assumption that honey is directly related to bees.

Many/most/all beekeepers harvest honey from their bees as a source of income, but they also sell or rent hives to farms. As the number of bees across the world have steadily dropped (for several reasons, none-of-which we will explore here), renting or selling hives has become a lucrative business. The sold or leased bees are taken to a farm and help to naturally pollinate farms and the lands around them, helping the farmer to grow crop, cultivate land, fertilize land, and develop the land more effectively. Since the bees return to the hive after foraging, they make honey from the nectar, are returned the beekeeper or farmer, who in turn can harvest the honey.


### More Initial Observations:










## Part 2 - Data:

Here I outline the data import process, review the data, clean it, tidy it, and structure it to suit our needs. Please see the [first appendix](https://github.com/chrisgmartin/HoneyIShrunkTheBees/tree/master/Appendix) at the end for more details on this process. The MySQL queries can also be found there.

### Data Import:

What is likely to be the most important part of any analysis, we need data to analyse. Fortunately for our project, there is a plethora of data freely available from a variety of sources.

After following some detailed [Stack Overflow](https://stackoverflow.com/questions/10292326/how-to-connect-r-with-mysql-or-how-to-install-rmysql-package) tips, I was able to connect to a local MySQL server that I created called 'HISP' (Honey, I Shrunk the Production). The HISP database stored a data from the sources below.


```{r}
library(RODBC)
con <- odbcConnect("hisp")
sqlQuery(con, "use hisp")
```


#### National Agriculture Statistics Service:

The first set of data we gathered came from the [National Agriculture Statistics Service website](https://quickstats.nass.usda.gov/) (NASS), which houses a large amount of data related to United States Agriculture. The website stores census and survey data on a number of subjects (the main categories are animals, products, crops, demographics, economics, and environment) across a number of geographic levels (national, state, county, and zip code) for a number of years. The data can be access by the website UI allowing the user to select each subject, geographic level, and year which can then be exported into a .CSV file, or the entire database can be downloaded as a text file after extracting the database .GZ. For our purposes, it was simple enough to query the database using the website rather than have to deal with the large and cumbersome dataset. The queries were then saved into seperate .CSV files, uploaded to GitHub, imported into MySQL, and prepped to be ready to import into R:

```{r}
#load the data
honey_county <- (sqlQuery(con, "select * from honey_county", stringsAsFactors=FALSE))
honey_state <- (sqlQuery(con, "select * from honey_state", stringsAsFactors=FALSE))

kable(head(honey_county, 3))
kable(head(honey_state, 3))

```

#### American National Standards Institute (ANSI) Codes

The NASS data sets include a column for ANSI codes at both the state and county level. These ANSI codes can be extremely useful in analyzing our data, especially when it comes to plotting it all on a map. ANSI stands for [American National Standards Institute](https://www.census.gov/geo/reference/ansi.html) which are standardized codes used to ensure uniform identification of geography between various agencies. Since September 2008, ANSI has also replaced the use of [Federial Information Processessing Standard](https://en.wikipedia.org/wiki/FIPS_county_code) (FIPS) codes and National Institute of Standards and Technology codes (NIST). 


```{r}
#load FIPS code to check if they are the same as ANSI codes at both state and county levels
```




#### Data on Bee Colonies

To verify if number of bees are going up or down











#### Closing the MySQL Connection:

Since we've finished with our MySQL connection, it should always be closed out to maintain data integrity.

```{r}
odbcClose(con)
```



### Data Exploration Part 1: County Level

Since we have the data set we can explore what's in it before we decide where and how to clean it. Let's start with the column for data descriptions: Data Item

```{r}
length(unique(honey_county$DataItem))
nrow(honey_county)
length(unique(honey_state$DataItem))
nrow(honey_state)

```

There are a lot more data items (87 more to be exact) in the state set than in the county set, yet the county set has more variables/row (33,548). This could mean a number of things but it certainly means that the starting point will be counties.

```{r}
unique(honey_county$DataItem)
```

We have a number of items here to sort through, but need to clean what can be cleaned. Other items of note are the columns. There are several that are unnecessary for our purposes. Essentially, the columns we need (or might need) are: Program (column 1), Period (3), GeoLevel (5), State (6), StateANSI (7), County (10), CountyANSI (11), Commodity (16), DataItem (17), and Value (20). The first 10 items are descriptive, while the final column contains our variable. *Note*: Year (2) has been removed for the time being, as our analysis is more of an estimate rather than a time-series and I believe that having more variables in our analysis will help more for stability than it will bias results.

### Data Cleaning

Let's pull in only the columns we need:

```{r}
honey_county2 <- honey_county[c(1,,5,6,7,10,11,16,17,20)]
```

Futher exploration of the data found several characters in the Value column, we'll have to fix that but need to first understand why the characters are there. Lucky for us, the NASS website also includes a [glossary](https://quickstats.nass.usda.gov/src/glossary.pdf) which is more than handy in a situation like this. The values we see here are: (D) and (Z), which mean "Withheald to avoid discolsing data for individual operations" and "Less than half of the rounding unit" respectively. As I understand it (Z) is essentially a (NULL) value and can be simply replaced with a 0 but (D) is tricky since it could be 0 or it could be extremely large. There are a number of things we could do to fix them: replace them with 0 (positively skewing our results), use a total average, use a weighted average based on a metric, average based on another metric, or make an assumption. What I think from my gut instinct is that using an average based on a metric would be the best way to do this as it is less prone to futher skewing our data in an extreme way. The metric that I think will be the most effective is an average for the state for the specific data item. Let's try to put that together:


```{r}
#Replace (Z)'s with 0 value
honey_county2$Value[honey_county2$Value == " (Z)"] <- as.integer(0)

#Set (D)'s to an easy to find value
honey_county2$Value[honey_county2$Value == " (D)"] <- as.integer(0)

#Remove comma's from digits
library(stringr)
honey_county2$Value <- str_replace_all(honey_county2$Value, "[:punct:]", "")





#Change Values into Int
honey_county2$Value <- as.integer(honey_county2$Value)
#Remove NA's to zero
honey_county2$Value[is.na(honey_county2$Value)] <- as.integer(0)


#Calculate the average of each DataItem for each State
library(dplyr)
#Start by sorting for ease
dataitem_county <- group_by(honey_county2, DataItem, State)
#Find the sum for each state and DataItem
(per_state_tot <- summarise(dataitem_county, Value = sum(Value)))
#Find the sum for each DataItem in totality
(per_nation_tot <- summarise(per_state, Value = sum(Value)))
#Find the average for each state and DataItem
(per_state_avg <- summarise(dataitem_county, Value = mean(Value)))
#Find the average for each DataItem in totality
(per_nation_avg <- summarise(per_state, Value = sum(Value)))
```


**************
**************
Need to fix NA values
Need to set "D" values as averages


*************
*************



### Data Tidying










### Data Restructuring







### Data Exploration Part 2: State Level



### Data Cleaning





### Data Tidying










### Data Restructuring



## Part 3 - Exploratory data analysis:


### Map





## Part 4 - Inference:


## Part 5 - Conclusion: 


## References:

[1]  Crane, Eva (1983) The Archaeology of Beekeeping, Cornell University Press, ISBN 0-8014-1609-4



## Appendix (optional):

Appendix 1: Data Merging in MySQL: [MySQL Query](https://github.com/chrisgmartin/HoneyIShrunkTheBees/blob/master/HoneyIShrunkTheBees.sql) and [Appendix 1 RMarkdown write-up](https://github.com/chrisgmartin/HoneyIShrunkTheBees/blob/master/Appendix/Appendix1-DataMySQL.Rmd)


